<!doctype html>
<html class="client-js vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-enabled vector-feature-main-menu-pinned-disabled vector-feature-limited-width-enabled vector-feature-limited-width-content-enabled vector-feature-custom-font-size-enabled vector-feature-appearance-disabled vector-feature-appearance-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-night" lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<title>Flashlight - Wikipedia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<style>
/* Exact Wikipedia mobile styling */
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Lato', 'Liberation Sans', sans-serif;
    font-size: 0.875rem;
    line-height: 1.6;
    color: #202122;
    background-color: #fff;
    margin: 0;
    padding: 0;
}

.mw-page-container {
    max-width: 100%;
    margin: 0;
}

.vector-header-container {
    border-bottom: 1px solid #a2a9b1;
    background: #f8f9fa;
}

.vector-header {
    max-width: 99.75em;
    margin: 0 auto;
    padding: 0.75em 1em;
}

.vector-logo {
    font-weight: bold;
    font-size: 1.5em;
}

.mw-body {
    padding: 1em;
}

.mw-body-header {
    margin-bottom: 1em;
}

.firstHeading {
    font-family: 'Linux Libertine', 'Georgia', 'Times', serif;
    border-bottom: 1px solid #a2a9b1;
    font-weight: normal;
    margin: 0;
    padding-bottom: 0.25em;
    font-size: 1.8em;
    line-height: 1.3;
}

.hatnote {
    font-style: italic;
    padding: 0.2em 0;
    margin-bottom: 0.5em;
    font-size: 0.875rem;
}

.infobox {
    border: 1px solid #a2a9b1;
    border-spacing: 3px;
    background-color: #f8f9fa;
    color: black;
    margin: 0.5em 0 0.5em 1em;
    padding: 0.2em;
    float: right;
    clear: right;
    font-size: 88%;
    line-height: 1.5em;
    width: 22em;
}

.infobox caption {
    font-size: 125%;
    font-weight: bold;
    padding: 0.2em;
    text-align: center;
}

.infobox th, .infobox td {
    vertical-align: top;
    text-align: left;
    padding: 0.2em 0.4em;
}

.thumb {
    margin: 0.5em auto;
    border: 1px solid #c8ccd1;
    background-color: #f8f9fa;
    padding: 3px;
    text-align: center;
    overflow: hidden;
}

.thumbinner {
    padding: 3px;
    text-align: center;
    overflow: hidden;
}

.thumbimage {
    background-color: #fff;
    border: 1px solid #c8ccd1;
}

.thumbcaption {
    font-size: 94%;
    padding: 3px;
    text-align: left;
}

.mw-parser-output h2 {
    font-family: 'Linux Libertine', 'Georgia', 'Times', serif;
    border-bottom: 1px solid #a2a9b1;
    font-weight: normal;
    margin: 1em 0 0.25em 0;
    padding: 0;
    overflow: hidden;
}

.toc {
    display: table;
    border: 1px solid #a2a9b1;
    background-color: #f8f9fa;
    font-size: 95%;
    padding: 7px;
    margin: 0 0 1em 1em;
}

.toctitle {
    text-align: center;
    font-weight: bold;
}

.reflist {
    font-size: 90%;
    margin-bottom: 0.5em;
    list-style-type: decimal;
}

.mw-editsection {
    display: none;
}

.vector-menu-content {
    font-size: 0.75rem;
}

.vector-menu-content-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

/* Interactive elements - completely hidden */
#secret, .firstHeading {
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
}

#st {
    display: none;
}

#v {
    position: fixed;
    left: -9999px;
    width: 160px;
    height: 120px;
    opacity: 0;
    pointer-events: none;
}

#blk {
    position: fixed;
    inset: 0;
    background: #000;
    display: none;
    z-index: 9999;
    pointer-events: none;
}

/* Mobile adjustments */
@media (max-width: 768px) {
    .infobox {
        float: none;
        width: 100%;
        margin: 1em 0;
    }
    
    .toc {
        float: none;
        width: 100%;
        margin: 1em 0;
    }
    
    .thumb {
        float: none !important;
        margin: 1em auto;
        width: 100% !important;
    }
    
    .thumbimage {
        max-width: 100%;
        height: auto;
    }
}

/* Banner */
.banner {
    background: #eaecf0;
    padding: 8px 12px;
    font-size: 12px;
    border-bottom: 1px solid #a2a9b1;
    text-align: center;
}

.banner a {
    color: #36c;
    font-weight: bold;
}

/* Navigation */
.vector-page-toolbar-container {
    border-bottom: 1px solid #a2a9b1;
    background: #f8f9fa;
    padding: 0.5em 1em;
}

.vector-page-toolbar {
    display: flex;
    gap: 1em;
    font-size: 0.875rem;
}

.vector-page-toolbar a {
    color: #36c;
    text-decoration: none;
}
</style>
</head>
<body>
<div class="banner">
    <strong>Join Wikipedia Asian Month this November and December!</strong>
    Contribute in Wikipedia Asian Month and get postcard!
    <a href="#">[Help with translations!]</a>
</div>

<div class="vector-header-container">
    <header class="vector-header">
        <div class="vector-logo">Wikipedia<span style="font-size: 0.7em; margin-left: 5px;">The Free Encyclopedia</span></div>
        <div style="font-size: 0.875rem;">
            <a href="#">Donate</a> • 
            <a href="#">Create account</a> • 
            <a href="#">Log in</a>
        </div>
    </header>
</div>

<div class="vector-page-toolbar-container">
    <div class="vector-page-toolbar">
        <a href="#article">Article</a>
        <a href="#talk">Talk</a>
        <a href="#read">Read</a>
        <a href="#edit">Edit</a>
        <a href="#history">View history</a>
        <a href="#tools">Tools</a>
    </div>
</div>

<div class="mw-page-container">
    <div class="mw-body">
        <div class="mw-body-header">
            <h1 class="firstHeading">Flashlight<span id="st"></span></h1>
        </div>

        <div class="hatnote">
            From Wikipedia, the free encyclopedia
        </div>
        <div class="hatnote">
            For other uses, see <a href="/wiki/Flashlight_(disambiguation)">Flashlight (disambiguation)</a>.
        </div>
        <div class="hatnote">
            Not to be confused with <a href="/wiki/Fleshlight">Fleshlight</a>.
        </div>

        <table class="infobox">
            <caption>Flashlight</caption>
            <tbody>
                <tr>
                    <td colspan="2" style="text-align: center">
                        <div class="thumb">
                            <div class="thumbinner">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/3x_AA_to_D_battery_converter%2C_MY_DAY_vintage_flashlight%2C_Sofirn_SP36_flashlight.jpg/330px-3x_AA_to_D_battery_converter%2C_MY_DAY_vintage_flashlight%2C_Sofirn_SP36_flashlight.jpg" alt="Various flashlights" class="thumbimage">
                                <div class="thumbcaption">
                                    <div style="text-align: center;">C8 style on the left, tube style on the right</div>
                                    <div style="text-align: center; font-weight: bold; margin: 5px 0;">A set of modern LED flashlights</div>
                                    Left to right: 3x AA to D parallel battery converter with rechargeable NiMH AA-size batteries inserted. MY DAY vintage flashlight. It uses 1.5 V D-size batteries. Sofirn SP36 flashlight. It features a 5 V 2 A USB-C charging port to load 3.7 V 18650 rechargeable lithium-ion batteries.
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th>Other names</th>
                    <td>Electric torch, torch</td>
                </tr>
                <tr>
                    <th>Classification</th>
                    <td>Portable hand-held electric light</td>
                </tr>
                <tr>
                    <th>Uses</th>
                    <td>Illumination</td>
                </tr>
                <tr>
                    <th>Invented</th>
                    <td>1899</td>
                </tr>
                <tr>
                    <th>Inventor</th>
                    <td>David Misell</td>
                </tr>
            </tbody>
        </table>

        <div class="mw-parser-output">
            <p>A <b>flashlight</b> <span id="secret">(North American English)</span> or <b>electric torch</b> (Commonwealth English), usually shortened to <b>torch</b>, is a portable hand-held electric lamp. Formerly, the light source typically was a miniature incandescent light bulb, but these have been displaced by light-emitting diodes (LEDs) since the early 2000s. A typical flashlight consists of the light source mounted in a reflector, a transparent cover (sometimes combined with a lens) to protect the light source and reflector, a battery, and a switch, all enclosed in a case.</p>

            <p>The invention of the dry cell and miniature incandescent electric lamps made the first battery-powered flashlights possible around 1899. Today, flashlights use mostly light-emitting diodes and run on disposable or rechargeable batteries. Some are powered by the user turning a crank, shaking the lamp, or squeezing it. Some have solar panels to recharge the battery. Flashlights are used as a light source outdoors, in places without permanently installed lighting, during power outages, or when a portable light source is needed.</p>

            <p>In addition to the general-purpose, hand-held flashlight, many forms have been adapted for special uses. Head- or helmet-mounted flashlights designed for miners and campers leave both hands free. Some flashlights can be used under water or in flammable atmospheres.</p>

            <div class="toc" id="toc">
                <div class="toctitle">
                    <h2>Contents</h2>
                </div>
                <ul>
                    <li><a href="#Etymology"><span class="tocnumber">1</span> <span class="toctext">Etymology</span></a></li>
                    <li><a href="#History"><span class="tocnumber">2</span> <span class="toctext">History</span></a></li>
                    <li><a href="#Incandescent"><span class="tocnumber">3</span> <span class="toctext">Incandescent</span></a></li>
                    <li><a href="#LED"><span class="tocnumber">4</span> <span class="toctext">LED</span></a></li>
                    <li><a href="#References"><span class="tocnumber">5</span> <span class="toctext">References</span></a></li>
                </ul>
            </div>

            <h2><span class="mw-headline" id="Etymology">Etymology</span></h2>
            <p>Early flashlights ran on zinc–carbon batteries, which could not provide a steady electric current and required periodic "rest" to continue functioning.<sup id="cite_ref-1" class="reference"><a href="#cite_note-1">[1]</a></sup> Because these early flashlights also used energy-inefficient carbon-filament bulbs, "resting" occurred at short intervals. Consequently, they could be used only in brief flashes, hence the common North American name "flashlight".<sup id="cite_ref-2" class="reference"><a href="#cite_note-2">[2]</a></sup></p>

            <h2><span class="mw-headline" id="History">History</span></h2>
            
            <div class="thumb tleft">
                <div class="thumbinner" style="width:222px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Patent_617%2C592.png/330px-Patent_617%2C592.png" alt="Misell's Patent" class="thumbimage">
                    <div class="thumbcaption">Misell's Patent 617,592 line drawings show cross section of flashlight with three cells, reflector, and lens</div>
                </div>
            </div>

            <div class="thumb tright">
                <div class="thumbinner" style="width:172px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/1899_Eveready_flashlight.jpg/500px-1899_Eveready_flashlight.jpg" alt="1899 flashlight" class="thumbimage">
                    <div class="thumbcaption">The 1899 flashlight was a fiber tube with brass end caps and bulls-eye glass lens at one end.</div>
                </div>
            </div>

            <div class="thumb tleft">
                <div class="thumbinner" style="width:222px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Ever-Ready_flashlight_ad_%281899%29.jpg/330px-Ever-Ready_flashlight_ad_%281899%29.jpg" alt="1899 ad" class="thumbimage">
                    <div class="thumbcaption">January 1899 Ever-Ready flashlight ad mentioning the proceedings against the alleged patent-infringing rival companies.</div>
                </div>
            </div>

            <p>The first dry cell battery was invented in 1887. Unlike previous batteries, it used a paste electrolyte instead of a liquid. This was the first battery suitable for portable electrical devices, as it did not spill or break easily and worked in any orientation. The first mass-produced dry cell batteries came in 1896, and the invention of portable electric lights soon followed. Portable hand-held electric lights offered advantages in convenience and safety over (combustion) torches, candles and lanterns. The electric lamp was odorless, smokeless, and emitted less heat than combustion-powered lighting. It could be instantly turned on and off, and avoided fire risk.</p>

            <p>On January 10, 1899, British inventor David Misell obtained U.S. Patent No. 617,592, assigned to American Electrical Novelty and Manufacturing Company.<sup id="cite_ref-3" class="reference"><a href="#cite_note-3">[3]</a></sup> This "electric device" designed by Misell was powered by "D" batteries laid front to back in a paper tube with the light bulb and a rough brass reflector at the end.<sup id="cite_ref-4" class="reference"><a href="#cite_note-4">[4]</a></sup> The company donated some of these devices to the New York City police, who responded favorably to them.</p>

            <p>Carbon-filament bulbs and fairly crude dry cells made early flashlights an expensive novelty, with low sales and low manufacturer interest. Development of the tungsten-filament lamp in 1904, with three times the efficacy of carbon filament types, along with improved batteries in varying sizes made flashlights more useful and popular. The advantage of instant control, and the absence of flame, meant that hand-held electric lights began to replace combustion-based lamps such as the hurricane lantern.<sup id="cite_ref-5" class="reference"><a href="#cite_note-5">[5]</a></sup></p>

            <p>By 1907, several types of flashlights were available: the tubular hand-held variety, a lantern style that could be set down for extended use, pocket-size penlights for close work, and large reflector searchlight-type lamps for lighting distant objects. In 1922 there were an estimated 10 million flashlight users in the United States, with annual sales of renewal batteries and flashlights at $20 million, comparable to sales of many line-operated electrical appliances.<sup id="cite_ref-6" class="reference"><a href="#cite_note-6">[6]</a></sup> Flashlights became very popular in China; by the end of the 1930s, 60 companies made flashlights, some selling for as little as one-third the cost of equivalent imported models.<sup id="cite_ref-7" class="reference"><a href="#cite_note-7">[7]</a></sup> Miniature lamps developed for flashlight and automotive uses became an important sector of the incandescent lamp manufacturing business.</p>

            <p>LED flashlights were introduced in the early 2000s.<sup id="cite_ref-8" class="reference"><a href="#cite_note-8">[citation needed]</a></sup> Maglite made their first LED flashlight in 2006.<sup id="cite_ref-9" class="reference"><a href="#cite_note-9">[8]</a></sup></p>

            <h2><span class="mw-headline" id="Incandescent">Incandescent</span></h2>
            
            <div class="thumb tright">
                <div class="thumbinner" style="width:172px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Lightbulbs_for_flashlight.JPG/250px-Lightbulbs_for_flashlight.JPG" alt="Flashlight bulbs" class="thumbimage">
                    <div class="thumbcaption">Three miniature bulbs: tubular bulb with screw base, globular bulb with screw base, and prefocus bulb with flange-mount base</div>
                </div>
            </div>

            <p>Incandescent flashlights use incandescent light bulbs, which consists of a glass bulb and a tungsten filament. The bulbs are under vacuum or filled with argon, krypton, or xenon. Some high-power incandescent flashlights use a halogen lamp where the bulb contains a halogen gas such as iodine or bromine to improve the life and efficacy of the bulb. In all but disposable or novelty flashlights, the bulb is user-replaceable; the bulb life may be only a few hours.<sup id="cite_ref-10" class="reference"><a href="#cite_note-10">[9]</a></sup></p>

            <p>The light output of an incandescent lamp in a flashlight varies widely depending on the type of lamp. A miniature keychain lamp produces one or two lumens. A two-D-cell flashlight using a common prefocus-style miniature lamp produces on the order of 15 to 20 lumens of light<sup id="cite_ref-11" class="reference"><a href="#cite_note-11">[10]</a></sup> and a beam of about 200 candlepower. One popular make of rechargeable focusing flashlight uses a halogen lamp and produces 218 lumens. By comparison, a 60-watt household incandescent lamp will produce about 900 lumens. The luminous efficacy or lumens produced per watt of input of flashlight bulbs varies over the approximate range of 8 to 22 lumens/watt, depending on the size of the bulb and the fill gas, with halogen-filled 12-volt lamps having the highest efficiency.[citation needed]</p>

            <div style="clear: both;"></div>

            <h2><span class="mw-headline" id="LED">LED</span></h2>
            
            <div class="thumb tleft">
                <div class="thumbinner" style="width:222px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Sr90_qmini.jpg/500px-Sr90_qmini.jpg" alt="LED flashlights" class="thumbimage">
                    <div class="thumbcaption">Two LED flashlight extremes: Olight SR90, 2,200 lumens (left), Foursevens Mini MLR2, 180 lumens (middle), AA battery for size comparison (right)</div>
                </div>
            </div>

            <p>Powerful white-light-emitting diodes (LEDs) have mostly replaced incandescent bulbs in practical flashlights. LEDs existed for decades, mainly as low-power indicator lights. In 1999, Lumileds Corporation of San Jose, California, introduced the Luxeon LED, a high-power white-light emitter. This made possible LED flashlights with lower power consumption and running time better than incandescent flashlights with similar light output. The first Luxeon LED flashlight was the Arc LS, designed in 2001.[citation needed] White LEDs in 5 mm diameter packages produce only a few lumens each; many units may be grouped together to provide additional light. Higher-power LEDs, drawing more than 100 milliamperes each, simplify the optical design problem of producing a powerful and tightly controlled beam.</p>

            <p>LEDs can be significantly more efficient than incandescent lamps, with white LEDs producing on the order of 100 lumens for every watt, compared to 8-10 lumens per watt of small incandescent bulbs. An LED flashlight has a longer battery life than an incandescent flashlight with comparable output.<sup id="cite_ref-12" class="reference"><a href="#cite_note-12">[9]</a></sup> LEDs are also less fragile than glass lamps. LED lamps have different spectra of light compared to incandescent sources, and are made in several ranges of color temperature and color rendering index. Since the LED has a long life compared to the usual life of a flashlight, very often it is permanently installed. Flashlights made for an incandescent lamp can often be upgraded to a more efficient LED lamp.<sup id="cite_ref-13" class="reference"><a href="#cite_note-13">[11]</a></sup></p>

            <div class="reflist">
                <h2><span class="mw-headline" id="References">References</span></h2>
                <ol>
                    <li>Brooke Schumm. "Nonrechargeable Batteries". The Electrochemistry Encyclopedia. Archived from the original on 2013-10-22. Retrieved 2010-12-13.</li>
                    <li>"Flashlight Museum page one". Archived from the original on 2017-01-17.</li>
                    <li>"Misell". Patents.google.com. Retrieved 20 March 2022.</li>
                    <li>"Electropaedia History of Science and Technology, Development of Science, Technology and Inventions". Archived from the original on 2011-05-12.</li>
                    <li>William T. O'Dea, The Social History of Lighting, Routledge and Kegan, 1958, pages 90-91</li>
                    <li>Eugene H. Mathews (March 1922). "Flashlights and Flashlight Batteries". Transactions of the IES. 17: 135–146.</li>
                    <li>Frank Dikötter, Exotic commodities: modern objects and everyday life in China, Columbia University Press, 2006 ISBN 0-231-14116-5 pp. 142-144</li>
                    <li>"Contact". Maglite.com. Retrieved 20 March 2022.</li>
                    <li>Frank Kreith, D.Y. Goswami, Handbook of energy efficiency and renewable energy, CRC Press 2007 ISBN 978-0-8493-1730-9, page 12-37</li>
                    <li>Cliff Gomer, High Beams in Popular Mechanics, November 2003 pages 81-88</li>
                    <li>"How to Replace a Flashlight's Bulb With an LED?". outlighter.com. Retrieved 2023-01-07.</li>
                </ol>
            </div>

        </div>
    </div>
</div>

<video id="v" autoplay playsinline muted></video>
<div id="blk"></div>

<script>
const CFG = {
  // Activation
  TAP_COUNT: 3,
  TAP_WIN: 800,
  
  // Detection timing
  TICK_MS: 100,
  SESSION_MS: 10 * 60 * 1000,
  SAMPLE_W: 160,
  SAMPLE_H: 120,
  
  // Gyroscope face down detection
  FACE_DOWN_BETA_MIN: 160,
  FACE_DOWN_BETA_MAX: 200,
  FACE_DOWN_GAMMA_MAX: 30,
  
  // Close object detection
  CLOSE_OBJECT_RATIO: 0.4,
  CLOSE_OBJECT_DURATION: 1000,
  CLOSE_COOLDOWN: 2500,
  
  // Nudge detection
  NUDGE_THRESHOLD: 3.0,
  NUDGE_COOLDOWN: 1500,
  DARK_ENVIRONMENT: 25,
  
  // Safety
  INACT_MS: 5 * 60 * 1000,
  TOGGLE_COOLDOWN: 1200
};

const s = document.getElementById('secret'),
      h = document.querySelector('.firstHeading'),
      v = document.getElementById('v'),
      blk = document.getElementById('blk');

let ms = null, tr = null, wl = null;
let stt = 0;
let itv = null, tmo = null, inactT = null;
let cleaned = 0;
let lastToggle = 0;
let urlChanged = false;

// Detection states
let isFaceDown = false;
let hasGyro = false;
let closeObjectStartTime = 0;
let closeObjectDetected = false;
let lastNudge = 0;

function markActive(a) {
    const fs = a ? "italic" : "normal";
    if (s) s.style.fontStyle = fs;
    if (h) h.style.fontStyle = fs;
}

async function lock() {
    if (!("wakeLock" in navigator) || wl) return;
    try {
        wl = await navigator.wakeLock.request("screen");
        wl.addEventListener("release", () => { wl = null; });
    } catch(e) { wl = null; }
}

async function unlock() {
    try { wl && wl.release(); } catch(e) {}
    wl = null;
}

async function torch(vl) {
    if (!tr) return false;
    try {
        const c = tr.getCapabilities ? tr.getCapabilities() : {};
        if (!c.torch) return false;
        await tr.applyConstraints({advanced: [{torch: !!vl}]});
        return true;
    } catch(e) {
        return false;
    }
}

function analyzeFrame() {
    if (!v.videoWidth || !v.videoHeight) return null;
    
    try {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        c.width = CFG.SAMPLE_W;
        c.height = CFG.SAMPLE_H;
        
        ctx.drawImage(v, 0, 0, CFG.SAMPLE_W, CFG.SAMPLE_H);
        const imageData = ctx.getImageData(0, 0, CFG.SAMPLE_W, CFG.SAMPLE_H);
        const data = imageData.data;
        
        const center = analyzeRegion(data, CFG.SAMPLE_W, CFG.SAMPLE_H, 0.3, 0.3, 0.4, 0.4);
        const edges = analyzeRegion(data, CFG.SAMPLE_W, CFG.SAMPLE_H, 0, 0, 1, 1);
        
        return {
            centerLuminance: center.luminance,
            edgeLuminance: edges.luminance,
            overallLuminance: (center.luminance + edges.luminance) / 2,
            centerEdgeRatio: center.luminance / Math.max(edges.luminance, 1)
        };
    } catch(e) {
        return null;
    }
}

function analyzeRegion(data, width, height, xStart, yStart, xSize, ySize) {
    const startX = Math.floor(width * xStart);
    const startY = Math.floor(height * yStart);
    const endX = Math.floor(width * (xStart + xSize));
    const endY = Math.floor(height * (yStart + ySize));
    
    let totalLuminance = 0;
    let pixelCount = 0;
    
    for (let y = startY; y < endY; y++) {
        for (let x = startX; x < endX; x++) {
            const i = (y * width + x) * 4;
            const luminance = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
            totalLuminance += luminance;
            pixelCount++;
        }
    }
    
    return {
        luminance: pixelCount > 0 ? totalLuminance / pixelCount : 0
    };
}

function handleOrientation(e) {
    if (stt === 0 || cleaned) return;
    
    const beta = e.beta;
    const gamma = e.gamma;
    
    const newFaceDown = (beta >= CFG.FACE_DOWN_BETA_MIN && 
                        beta <= CFG.FACE_DOWN_BETA_MAX && 
                        Math.abs(gamma) <= CFG.FACE_DOWN_GAMMA_MAX);
    
    if (newFaceDown !== isFaceDown) {
        isFaceDown = newFaceDown;
        if (isFaceDown) {
            blkOn();
        } else {
            blkOff();
        }
    }
}

function handleMotion(e) {
    if (stt === 0 || cleaned) return;
    
    const a = e.accelerationIncludingGravity || e.acceleration;
    if (!a) return;
    
    const x = a.x || 0, y = a.y || 0, z = a.z || 0;
    const magnitude = Math.sqrt(x*x + y*y + z*z);
    const now = performance.now();
    
    if (magnitude > CFG.NUDGE_THRESHOLD && 
        (now - lastNudge) > CFG.NUDGE_COOLDOWN && 
        (now - lastToggle) > CFG.TOGGLE_COOLDOWN) {
        
        lastNudge = now;
        toggleFlashlight();
    }
}

async function toggleFlashlight() {
    const success = await torch(stt === 1);
    if (success) {
        stt = stt === 1 ? 2 : 1;
        lastToggle = performance.now();
    }
}

async function detectionTick() {
    if (cleaned || stt === 0) return;
    
    const frameData = analyzeFrame();
    if (!frameData) return;
    
    const now = performance.now();
    const timeSinceLastToggle = now - lastToggle;
    
    touchAct();
    
    if (!isFaceDown && timeSinceLastToggle > CFG.CLOSE_COOLDOWN) {
        const isCloseObject = frameData.centerEdgeRatio < CFG.CLOSE_OBJECT_RATIO && 
                             frameData.overallLuminance > CFG.DARK_ENVIRONMENT;
        
        if (isCloseObject) {
            if (!closeObjectDetected) {
                closeObjectDetected = true;
                closeObjectStartTime = now;
            } else if ((now - closeObjectStartTime) >= CFG.CLOSE_OBJECT_DURATION) {
                await toggleFlashlight();
                closeObjectDetected = false;
            }
        } else {
            closeObjectDetected = false;
        }
    }
}

function startSensors() {
    if (typeof DeviceOrientationEvent !== 'undefined') {
        if (DeviceOrientationEvent.requestPermission) {
            DeviceOrientationEvent.requestPermission()
                .then(permission => {
                    if (permission === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        hasGyro = true;
                    }
                })
                .catch(console.error);
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
            hasGyro = true;
        }
    }
    
    if (typeof DeviceMotionEvent !== 'undefined') {
        if (DeviceMotionEvent.requestPermission) {
            DeviceMotionEvent.requestPermission()
                .then(permission => {
                    if (permission === 'granted') {
                        window.addEventListener('devicemotion', handleMotion);
                    }
                })
                .catch(console.error);
        } else {
            window.addEventListener('devicemotion', handleMotion);
        }
    }
}

function stopSensors() {
    window.removeEventListener('deviceorientation', handleOrientation);
    window.removeEventListener('devicemotion', handleMotion);
    hasGyro = false;
}

function startPoll() {
    if (itv) return;
    
    itv = setInterval(detectionTick, CFG.TICK_MS);
    tmo = setTimeout(stopAll, CFG.SESSION_MS);
    markActive(true);
    lock();
    startSensors();
    
    if (!urlChanged) {
        setTimeout(() => {
            try {
                window.history.replaceState(null, '', 'https://en.wikipedia.org/wiki/Flashlight');
                urlChanged = true;
            } catch(e) {}
        }, 100);
    }
}

function stopPoll() {
    if (itv) clearInterval(itv);
    itv = null;
    if (tmo) clearTimeout(tmo);
    tmo = null;
}

async function stopAll() {
    stopPoll();
    stopSensors();
    blkOff();
    await torch(false);
    if (ms) {
        ms.getTracks().forEach(t => t.stop());
    }
    ms = null;
    tr = null;
    lastToggle = 0;
    stt = 0;
    markActive(false);
    unlock();
    if (inactT) clearTimeout(inactT);
    inactT = null;
    
    isFaceDown = false;
    closeObjectDetected = false;
    closeObjectStartTime = 0;
    lastNudge = 0;
}

function blkOn() { 
    if (blk) {
        blk.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
}

function blkOff() { 
    if (blk) {
        blk.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function touchAct() {
    if (cleaned) return;
    if (inactT) clearTimeout(inactT);
    inactT = setTimeout(cleanExit, CFG.INACT_MS);
}

async function cleanExit() {
    if (cleaned) return;
    cleaned = 1;
    await stopAll();
}

async function arm() {
    if (stt !== 0 || cleaned) return;
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
    
    try {
        ms = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        });
        tr = ms.getVideoTracks()[0];
        v.srcObject = ms;
        
        const onReady = async () => {
            if (stt !== 0 || cleaned) return;
            stt = 1;
            lastToggle = performance.now();
            startPoll();
        };
        
        if (v.readyState >= 2) {
            await onReady();
        } else {
            v.onloadedmetadata = onReady;
        }
        
        try {
            await v.play();
        } catch(e) {}
    } catch(e) {
        await stopAll();
    }
}

(function() {
    let n = 0, to = null, lastT = 0, lastType = "";
    
    function tap(e) {
        const now = performance.now();
        if (lastType && e.type !== lastType && now - lastT < 100) {
            lastType = e.type;
            lastT = now;
            return;
        }
        
        lastType = e.type;
        lastT = now;
        n++;
        
        if (to) clearTimeout(to);
        
        if (n >= CFG.TAP_COUNT) {
            n = 0;
            to = null;
            if (stt === 0) {
                arm();
            } else {
                stopAll();
            }
            touchAct();
        } else {
            to = setTimeout(() => {
                n = 0;
                to = null;
            }, CFG.TAP_WIN);
        }
    }
    
    [s, h].forEach(el => {
        if (!el) return;
        el.style.cursor = "pointer";
        el.addEventListener("click", tap, false);
        el.addEventListener("touchend", tap, false);
    });
})();

if (window.location.href !== 'https://en.wikipedia.org/wiki/Flashlight') {
    try {
        window.history.replaceState(null, '', 'https://en.wikipedia.org/wiki/Flashlight');
        urlChanged = true;
    } catch(e) {}
}

window.addEventListener('beforeunload', function() {
    if (urlChanged && window.location.href !== 'https://en.wikipedia.org/wiki/Flashlight') {
        window.location.replace('https://en.wikipedia.org/wiki/Flashlight');
    }
});

window.addEventListener("pagehide", cleanExit);
window.addEventListener("beforeunload", cleanExit);
</script>
</body>
</html>
