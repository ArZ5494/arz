<!doctype html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Flashlight — Encyclopedia</title>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*{touch-action:manipulation}
body{font-family:"Noto Serif",Georgia,serif;background:#fff;color:#111;margin:0}
.container{max-width:760px;padding:12px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;padding:8px 0}
.logo{width:44px;height:44px;border-radius:6px;background:#eef1f4;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2b2f33}
.h1{font-size:1.35rem;margin:0;font-weight:700;display:flex;align-items:center;gap:6px}
#st{width:6px;height:6px;border-radius:50%;background:#c5cdd6;opacity:.25;transition:.25s}
#secret{cursor:pointer;transition:.25s}
.lead{color:#222;font-size:.95rem;margin:.4rem 0}
.infobox{border:1px solid #d6d9dc;padding:.6rem;border-radius:6px;background:#fbfcfd;margin:8px 0;transition:.25s}
.infobox.active{border-color:#d6d9dc;background:#fbfcfd}
figure img{max-width:100%;height:auto;border-radius:6px}
figcaption,.caption{font-size:.85rem;color:#666;margin-top:.25rem}
#v{position:fixed;left:-9999px;width:160px;height:120px;opacity:0;pointer-events:none}
@media(max-width:420px){.h1{font-size:1.1rem}}
</style>
<body>
<div class="container" role="main">
  <div class="header">
    <div class="logo" aria-hidden="true">E</div>
    <div>
      <div class="h1">Flashlight<span id="st"></span></div>
      <div style="font-size:.82rem;color:#666">Portable hand-held illumination</div>
    </div>
  </div>
  <div class="lead">
    A <em>flashlight</em> (also called a torch) is a portable hand-held electric light.
  </div>
  <div class="infobox" id="ibox">
    <strong>Quick facts</strong>
    <p>Modern flashlights use LEDs, batteries, reflectors and lenses.</p>
  </div>
  <figure>
    <img src="https://images.unsplash.com/photo-1518779578993-ec3579fee39f?w=1200&q=70&auto=format&fit=crop" alt="LED flashlight">
    <figcaption>Typical modern LED flashlight.</figcaption>
  </figure>
  <p>
    The <span id="secret">Flashlight</span> has evolved from incandescent bulbs to efficient LEDs.
    Some devices allow the browser to control the rear torch while the camera is active.
  </p>
  <h2>Design</h2>
  <p>
    Flashlights contain a light source, power supply and a switch. In certain supported mobile browsers,
    camera input can be used to drive subtle interactive effects.
  </p>
  <div class="caption">
    Triple-tap “Flashlight” (heading or inline) to arm. Use light/cover gestures near the camera to toggle.
  </div>
</div>

<video id="v" autoplay playsinline muted></video>

<script>
/* constants */
const T=3,WIN=600,SM=120,LIM=12e5,W=160,H=120;
const UP_F=4,DN_F=3,BASE_FR=8,TRIG_FR=3,CD=900;

const s=document.getElementById('secret'),
      h=document.querySelector('.h1'),
      v=document.getElementById('v'),
      ib=document.getElementById('ibox');

let ms=null,tr=null,wl=null;
let stt=0;           // 0 idle,1 armed_off,2 armed_on
let blOff=0,blOn=0;  // baselines
let oPrev=0,oCnt=0,oAcc=0;
let nPrev=0,nCnt=0,nAcc=0;
let upCnt=0,dnCnt=0;
let lastToggle=0;
let itv=null,tmo=null;

/* subtle indicator: italics only when armed */
function mark(a){
  const fs=a?"italic":"normal";
  if(s)s.style.fontStyle=fs;
  if(h)h.style.fontStyle=fs;
}

/* wake lock */
async function lock(){
  if(!("wakeLock" in navigator)||wl) return;
  try{
    wl=await navigator.wakeLock.request("screen");
    wl.addEventListener("release",()=>{wl=null;});
  }catch(e){wl=null;}
}
async function unlock(){
  try{wl&&wl.release();}catch(e){}
  wl=null;
}

/* torch control */
async function torch(vl){
  if(!tr)return;
  try{
    const c=tr.getCapabilities?tr.getCapabilities():{};
    if(!c.torch)return;
    await tr.applyConstraints({advanced:[{torch:!!vl}]});
  }catch(e){}
}

/* luminance (center crop) */
function lum(){
  if(!v.videoWidth||!v.videoHeight)return 0;
  try{
    const c=document.createElement('canvas'),x=c.getContext('2d');
    c.width=W;c.height=H;
    x.drawImage(v,0,0,W,H);
    const d=x.getImageData(W*0.25,H*0.2,W*0.5,H*0.6).data;
    let sL=0,n=0;
    for(let i=0;i<d.length;i+=4){
      sL+=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
      n++;
    }
    return n?sL/n:0;
  }catch(e){return 0;}
}

/* baseline calibration helpers */
function calOff(L){
  if(!L)return;
  if(!oPrev){oPrev=L;oCnt=1;oAcc=L;return;}
  if(Math.abs(L-oPrev)<6){
    oCnt++;oAcc+=L;oPrev=L;
  }else{
    oCnt=1;oAcc=L;oPrev=L;
  }
  if(oCnt>=BASE_FR)blOff=oAcc/oCnt;
}
function calOn(L){
  if(!L)return;
  if(!nPrev){nPrev=L;nCnt=1;nAcc=L;return;}
  if(Math.abs(L-nPrev)<8){
    nCnt++;nAcc+=L;nPrev=L;
  }else{
    nCnt=1;nAcc=L;nPrev=L;
  }
  if(nCnt>=BASE_FR)blOn=nAcc/nCnt;
}

/* stateful tick */
async function tick(){
  const L=lum();
  const now=performance.now();
  if(!L)return;

  if(stt===1){ // ARMED_OFF
    if(!blOff){
      calOff(L);
      return;
    }
    if(L>blOff*UP_F){
      upCnt++;
    }else if(L<blOff*2){
      upCnt=0;
    }
    if(upCnt>=TRIG_FR && now-lastToggle>CD){
      await torch(true);
      stt=2;
      blOn=0; // will recalibrate ON
      nPrev=nCnt=nAcc=0;
      upCnt=0;dnCnt=0;
      lastToggle=now;
      return;
    }
  }else if(stt===2){ // ARMED_ON
    if(!blOn){
      calOn(L);
      return;
    }
    if(L<blOn/DN_F){
      dnCnt++;
    }else if(L>blOn/1.5){
      dnCnt=0;
    }
    if(dnCnt>=TRIG_FR && now-lastToggle>CD){
      await torch(false);
      stt=1;
      blOff=0; // recalc OFF for new environment
      oPrev=oCnt=oAcc=0;
      upCnt=0;dnCnt=0;
      lastToggle=now;
      return;
    }
  }
}

/* start/stop loops */
function startPoll(){
  if(itv)return;
  itv=setInterval(tick,SM);
  tmo=setTimeout(stopAll,LIM);
  mark(1);
}
function stopPoll(){
  if(itv)clearInterval(itv);
  itv=null;
  if(tmo)clearTimeout(tmo);
  tmo=null;
}

/* stop everything */
async function stopAll(){
  stopPoll();
  await torch(false);
  if(ms)ms.getTracks().forEach(t=>t.stop());
  ms=null;tr=null;
  blOff=blOn=0;
  oPrev=oCnt=oAcc=0;
  nPrev=nCnt=nAcc=0;
  upCnt=dnCnt=0;
  lastToggle=0;
  stt=0;
  mark(0);
  unlock();
}

/* start camera + arm */
async function arm(){
  if(stt!==0)return;
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return;
  try{
    ms=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}}
    });
    tr=ms.getVideoTracks()[0];
    v.srcObject=ms;
    const onReady=async()=>{
      if(stt!==0)return;
      stt=1;           // ARMED_OFF, will calibrate blOff
      blOff=blOn=0;
      oPrev=oCnt=oAcc=0;
      nPrev=nCnt=nAcc=0;
      upCnt=dnCnt=0;
      lastToggle=performance.now();
      startPoll();
      lock();
    };
    if(v.readyState>=2)onReady();else v.onloadedmetadata=onReady;
    try{await v.play();}catch(e){}
  }catch(e){
    await stopAll();
  }
}

/* triple-tap toggle: IDLE <-> ARMED */
(function(){
  let n=0,to=null,lastT=0,lastType="";
  function tap(e){
    const now=performance.now();
    if(lastType && e.type!==lastType && now-lastT<80){
      lastType=e.type;lastT=now;return;
    }
    lastType=e.type;lastT=now;
    n++;
    if(to)clearTimeout(to);
    if(n>=T){
      n=0;to=null;
      stt===0?arm():stopAll();
    }else{
      to=setTimeout(()=>{n=0;to=null},WIN);
    }
  }
  [s,h].forEach(el=>{
    if(!el)return;
    el.style.cursor="pointer";
    el.addEventListener('click',tap,false);
    el.addEventListener('touchend',tap,false);
  });
})();

window.addEventListener('pagehide',()=>{stopAll();});
</script>
</body>
</html>
