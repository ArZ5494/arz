<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Flashlight — Encyclopedia</title>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*{touch-action:manipulation}
body{font-family:"Noto Serif",Georgia,serif;background:#fff;color:#111;margin:0}
.container{max-width:760px;padding:12px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;padding:8px 0}
.logo{width:44px;height:44px;border-radius:6px;background:#eef1f4;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2b2f33}
.h1{font-size:1.35rem;margin:0;font-weight:700;display:flex;align-items:center;gap:6px}
#st{width:7px;height:7px;border-radius:50%;background:#c5cdd6;opacity:.6;transition:.25s}
.lead{color:#222;font-size:.95rem;margin:.4rem 0}
.infobox{border:1px solid #d6d9dc;padding:.6rem;border-radius:6px;background:#fbfcfd;margin:8px 0;transition:.25s}
.infobox.active{border-color:#9ed2ae;background:#f4fbf6}
figure img{max-width:100%;height:auto;border-radius:6px}
figcaption,.caption{font-size:.85rem;color:#666;margin-top:.25rem}
#v{position:fixed;left:-9999px;width:160px;height:120px;opacity:0;pointer-events:none}
@media(max-width:420px){.h1{font-size:1.1rem}}
</style>

<div class="container" role="main">
  <div class="header">
    <div class="logo" aria-hidden="true">E</div>
    <div>
      <div class="h1">Flashlight<span id="st"></span></div>
      <div style="font-size:.82rem;color:#666">Portable hand-held illumination</div>
    </div>
  </div>
  <div class="lead">
    A <em>flashlight</em> (also called a torch) is a portable hand-held electric light.
  </div>
  <div class="infobox" id="ibox">
    <strong>Quick facts</strong>
    <p>Modern flashlights use LEDs, batteries, reflectors and lenses.</p>
  </div>
  <figure>
    <img src="https://images.unsplash.com/photo-1518779578993-ec3579fee39f?w=1200&q=70&auto=format&fit=crop" alt="LED flashlight">
    <figcaption>Typical modern LED flashlight.</figcaption>
  </figure>
  <p>
    The <span id="secret" style="cursor:pointer">Flashlight</span> has evolved from incandescent bulbs to efficient LEDs.
    Some devices allow the browser to control the rear torch while the camera is active.
  </p>
  <h2>Design</h2>
  <p>
    Flashlights contain a light source, power supply and a switch. In certain supported mobile browsers, camera input can be used
    to drive subtle interactive effects.
  </p>
  <div class="caption">Tap “Flashlight” three times to link device features on supported phones.</div>
</div>

<video id="v" autoplay playsinline muted></video>

<script>
const T=3,WN=700,REQ=800,SM=120,A=.25,ON=45,LIM=12e5,W=160,H=120;
const s=document.getElementById('secret'),v=document.getElementById('v'),st=document.getElementById('st'),ib=document.getElementById('ibox');
let stm=null,tr=null,en=0,on=0,p=null,ema=255,cov=0,t0=0,ok=1,timer=null;

function hint(a){
  if(!st||!ib)return;
  if(a){
    st.style.background="#48b26b";
    st.style.opacity="1";
    ib.classList.add("active");
  }else{
    st.style.background="#c5cdd6";
    st.style.opacity=".6";
    ib.classList.remove("active");
  }
}

function msg(e){
  alert((e&&e.message)||e||'Camera/torch not available on this device/browser.');
}

async function setTorch(vl){
  if(!tr)return;
  try{
    await tr.applyConstraints({advanced:[{torch:!!vl}]});
    on=!!vl;
  }catch(e){
    console.log(e);
    if(vl)msg('Torch control not supported here.');
  }
}

function L(){
  try{
    const c=document.createElement('canvas');
    c.width=W;c.height=H;
    const x=c.getContext('2d');
    x.drawImage(v,0,0,W,H);
    const d=x.getImageData(W*.25,H*.25,W*.5,H*.5).data;
    let s=0,n=0;
    for(let i=0;i<d.length;i+=4){
      s+=.299*d[i]+.587*d[i+1]+.114*d[i+2];
      n++;
    }
    return n?s/n:255;
  }catch(_){
    return 255;
  }
}

function tick(){
  const l=L();
  ema=A*l+(1-A)*ema;
  if(ema<ON){
    if(!cov){
      cov=1;
      t0=performance.now();
    }else if(performance.now()-t0>=REQ&&ok){
      setTorch(!on);
      ok=0;
    }
  }else if(cov){
    cov=0;
    t0=0;
    ok=1;
  }
}

function startPoll(){
  if(p)return;
  ema=255;cov=0;t0=0;ok=1;
  p=setInterval(tick,SM);
  timer=setTimeout(stopAll,LIM);
  hint(1);
}

function stopPoll(){
  if(p)clearInterval(p);
  p=null;
  if(timer)clearTimeout(timer);
  timer=null;
}

function stopAll(){
  stopPoll();
  try{
    tr&&tr.applyConstraints&&tr.applyConstraints({advanced:[{torch:false}]});
  }catch(_){}
  if(stm)stm.getTracks().forEach(t=>t.stop());
  stm=null;tr=null;en=0;on=0;
  hint(0);
}

async function start(){
  if(en)return;
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    msg('Camera not available in this browser.');
    return;
  }
  try{
    stm=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}}
    });
    tr=stm.getVideoTracks()[0];
    v.srcObject=stm;
    const c=tr.getCapabilities?tr.getCapabilities():{};
    if(!c.torch){
      msg('Torch control not supported on this device/browser.');
      stopAll();
      return;
    }
    en=1;
    startPoll();
  }catch(e){
    stopAll();
    msg(e);
  }
}

(function(){
  let n=0,t=null;
  function tap(){
    n++;
    if(t)clearTimeout(t);
    t=setTimeout(function(){n=0;t=null},WN);
    if(n>=T){
      n=0;
      clearTimeout(t);
      t=null;
      en?stopAll():start();
    }
  }
  s.addEventListener('pointerup',tap,{passive:true});
  s.addEventListener('click',tap);
})();

window.addEventListener('pagehide',stopAll);
</script>
