<!doctype html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Flashlight — Encyclopedia</title>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*{touch-action:manipulation}
body{font-family:"Noto Serif",Georgia,serif;background:#fff;color:#111;margin:0}
.container{max-width:760px;padding:12px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;padding:8px 0}
.logo{width:44px;height:44px;border-radius:6px;background:#eef1f4;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2b2f33}
.h1{font-size:1.35rem;margin:0;font-weight:700;display:flex;align-items:center;gap:6px}
#st{width:6px;height:6px;border-radius:6px;background:#c5cdd6;opacity:.25;transition:.25s}
#secret{cursor:pointer;transition:.25s}
.lead{color:#222;font-size:.95rem;margin:.4rem 0}
.infobox{border:1px solid #d6d9dc;padding:.6rem;border-radius:6px;background:#fbfcfd;margin:8px 0;transition:.25s}
.infobox.active{border-color:#d6d9dc;background:#fbfcfd}
figure img{max-width:100%;height:auto;border-radius:6px}
figcaption,.caption{font-size:.85rem;color:#666;margin-top:.25rem}
#v{position:fixed;left:-9999px;width:160px;height:120px;opacity:0;pointer-events:none}
#blk{position:fixed;inset:0;background:#000;display:none;z-index:9999;pointer-events:none}
@media(max-width:420px){.h1{font-size:1.1rem}}
</style>
<body>
<div class="container" role="main">
  <div class="header">
    <div class="logo" aria-hidden="true">E</div>
    <div>
      <div class="h1">Flashlight<span id="st"></span></div>
      <div style="font-size:.82rem;color:#666">Portable hand-held electric light</div>
    </div>
  </div>

  <!-- Start of Wikipedia Content -->
  <div class="lead">
    A <em id="secret">flashlight</em> (North American English) or electric torch (Commonwealth English), usually shortened to torch, is a portable hand-held electric lamp. Formerly, the light source typically was a miniature incandescent light bulb, but these have been displaced by light-emitting diodes (LEDs) since the early 2000s. A typical flashlight consists of the light source mounted in a reflector, a transparent cover (sometimes combined with a lens) to protect the light source and reflector, a battery, and a switch, all enclosed in a case.[citation:1]
  </div>

  <div class="infobox" id="ibox">
    <strong>Quick facts</strong>
    <p>The invention of the dry cell and miniature incandescent electric lamps made the first battery-powered flashlights possible around 1899. Today, flashlights use mostly light-emitting diodes and run on disposable or rechargeable batteries. Some are powered by the user turning a crank, shaking the lamp, or squeezing it. Some have solar panels to recharge the battery.[citation:1]</p>
  </div>

  <p>
    The invention of the dry cell and miniature incandescent electric lamps made the first battery-powered flashlights possible around 1899. Today, flashlights use mostly light-emitting diodes and run on disposable or rechargeable batteries. Some are powered by the user turning a crank, shaking the lamp, or squeezing it. Some have solar panels to recharge the battery. Flashlights are used as a light source outdoors, in places without permanently installed lighting, during power outages, or when a portable light source is needed.[citation:1]
  </p>

  <h2>Etymology</h2>
  <p>
    Early flashlights ran on zinc–carbon batteries, which could not provide a steady electric current and required periodic "rest" to continue functioning. Because these early flashlights also used energy-inefficient carbon-filament bulbs, "resting" occurred at short intervals. Consequently, they could be used only in brief flashes, hence the common North American name "flashlight".[citation:1]
  </p>

  <h2>History</h2>
  <p>
    The first dry cell battery was invented in 1887. Unlike previous batteries, it used a paste electrolyte instead of a liquid. This was the first battery suitable for portable electrical devices, as it did not spill or break easily and worked in any orientation. The first mass-produced dry cell batteries came in 1896, and the invention of portable electric lights soon followed. Portable hand-held electric lights offered advantages in convenience and safety over (combustion) torches, candles and lanterns. The electric lamp was odorless, smokeless, and emitted less heat than combustion-powered lighting. It could be instantly turned on and off, and avoided fire risk.[citation:1]
  </p>
  <p>
    On January 10, 1899, British inventor David Misell obtained U.S. Patent No. 617,592, assigned to American Electrical Novelty and Manufacturing Company. This "electric device" designed by Misell was powered by "D" batteries laid front to back in a paper tube with the light bulb and a rough brass reflector at the end. The company donated some of these devices to the New York City police, who responded favorably to them.[citation:1]
  </p>

  <h2>LED</h2>
  <p>
    Powerful white-light-emitting diodes (LEDs) have mostly replaced incandescent bulbs in practical flashlights. LEDs existed for decades, mainly as low-power indicator lights. In 1999, Lumileds Corporation of San Jose, California, introduced the Luxeon LED, a high-power white-light emitter. This made possible LED flashlights with lower power consumption and running time better than incandescent flashlights with similar light output. The first Luxeon LED flashlight was the Arc LS, designed in 2001.[citation:1]
  </p>
  <p>
    LEDs can be significantly more efficient than incandescent lamps, with white LEDs producing on the order of 100 lumens for every watt, compared to 8-10 lumens per watt of small incandescent bulbs. An LED flashlight has a longer battery life than an incandescent flashlight with comparable output. LEDs are also less fragile than glass lamps.[citation:1]
  </p>

  <h2>Other power sources</h2>
  <p>
    Since batteries can be a burdensome cost in developed countries, let alone in the third world, the development of self-powered torches is a welcome advance. Some use solar panels to recharge their batteries during the day. The clockwork torch has a spring with a winding handle, which powers the torch for a period of time.[citation:5]
  </p>
  <p>
    Some flashlights have an electrical generator built into it. Dynamo-powered flashlights have a winding crank connected to a stepper motor that feeds several diode bridges with their outputs connected in parallel feeding a field effect transistor that charges a capacitor that connects to one or more LEDs. Others generate electricity using electromagnetic induction.[citation:5]
  </p>
  <!-- End of Wikipedia Content -->

  <div class="caption">
    Triple-tap "Flashlight" (heading or inline) to arm. Phone face-down → screen goes black. Use light/cover or firm tap to toggle.
  </div>
</div>

<video id="v" autoplay playsinline muted></video>
<div id="blk"></div>

<script>
/* ================= CONFIG: TUNE HERE ONLY ================= */
const CFG={
  TAP_COUNT:3,           // taps to arm/disarm
  TAP_WIN:600,           // max gap (ms) between taps
  TICK_MS:120,           // polling interval
  SESSION_MS:12e5,       // auto stop safety (ms)
  SAMPLE_W:160,
  SAMPLE_H:120,

  UP_F:4,                // OFF->ON: L > blOff * UP_F
  DN_F:3,                // ON->OFF: L < blOn / DN_F
  BASE_FR:8,             // frames needed to lock baseline
  TRIG_FR:3,             // frames over/under threshold to trigger
  COOLDOWN_MS:900,       // min gap between toggles

  DARK_LIM:18,           // avg L considered "very dark"
  BUMP_THR:2.2,          // accel magnitude for "crisp" bump
  DARK_BWIN:700,         // ms: bump must be near now in dark

  BLK_LIM:35,            // L threshold for auto-black screen
  INACT_MS:600000        // inactivity before clean exit (ms)
};
/* ========================================================== */

const s=document.getElementById('secret'),
      h=document.querySelector('.h1'),
      v=document.getElementById('v'),
      blk=document.getElementById('blk');

let ms=null,tr=null,wl=null;
let stt=0;                 // 0 idle,1 armed_off,2 armed_on
let blOff=0,blOn=0;
let oPrev=0,oCnt=0,oAcc=0;
let nPrev=0,nCnt=0,nAcc=0;
let upCnt=0,dnCnt=0;
let lastToggle=0;
let itv=null,tmo=null;
let lastBump=0;
let inactT=null,cleaned=0;

function mark(a){
  const fs=a?"italic":"normal";
  if(s)s.style.fontStyle=fs;
  if(h)h.style.fontStyle=fs;
}
function blkOn(){blk.style.display='block';}
function blkOff(){blk.style.display='none';}

function touchAct(){
  if(cleaned)return;
  if(inactT)clearTimeout(inactT);
  inactT=setTimeout(cleanExit,CFG.INACT_MS);
}

async function lock(){
  if(!("wakeLock" in navigator)||wl)return;
  try{
    wl=await navigator.wakeLock.request("screen");
    wl.addEventListener("release",()=>{wl=null;});
  }catch(e){wl=null;}
}
async function unlock(){
  try{wl&&wl.release();}catch(e){}
  wl=null;
}

async function torch(vl){
  if(!tr)return;
  try{
    const c=tr.getCapabilities?tr.getCapabilities():{};
    if(!c.torch)return;
    await tr.applyConstraints({advanced:[{torch:!!vl}]});
  }catch(e){}
}

function lum(){
  if(!v.videoWidth||!v.videoHeight)return 0;
  try{
    const c=document.createElement('canvas'),x=c.getContext('2d');
    c.width=CFG.SAMPLE_W;c.height=CFG.SAMPLE_H;
    x.drawImage(v,0,0,CFG.SAMPLE_W,CFG.SAMPLE_H);
    const d=x.getImageData(
      CFG.SAMPLE_W*0.25,
      CFG.SAMPLE_H*0.2,
      CFG.SAMPLE_W*0.5,
      CFG.SAMPLE_H*0.6
    ).data;
    let sL=0,n=0;
    for(let i=0;i<d.length;i+=4){
      sL+=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
      n++;
    }
    return n?sL/n:0;
  }catch(e){return 0;}
}

/* baselines */
function calOff(L){
  if(!L)return;
  if(!oPrev){oPrev=L;oCnt=1;oAcc=L;return;}
  if(Math.abs(L-oPrev)<6){oCnt++;oAcc+=L;oPrev=L;}
  else{oCnt=1;oAcc=L;oPrev=L;}
  if(oCnt>=CFG.BASE_FR)blOff=oAcc/oCnt;
}
function calOn(L){
  if(!L)return;
  if(!nPrev){nPrev=L;nCnt=1;nAcc=L;return;}
  if(Math.abs(L-nPrev)<8){nCnt++;nAcc+=L;nPrev=L;}
  else{nCnt=1;nAcc=L;nPrev=L;}
  if(nCnt>=CFG.BASE_FR)blOn=nAcc/nCnt;
}

/* devicemotion for dark fallback */
function dmHandler(e){
  const a=e.accelerationIncludingGravity||e.acceleration;
  if(!a)return;
  const x=a.x||0,y=a.y||0,z=a.z||0;
  const mag=Math.sqrt(x*x+y*y+z*z);
  if(mag>CFG.BUMP_THR){
    lastBump=performance.now();
    touchAct();
  }
}
function enableDM(){
  lastBump=0;
  if(typeof DeviceMotionEvent!=="undefined" && DeviceMotionEvent.requestPermission){
    DeviceMotionEvent.requestPermission().then(p=>{
      if(p==="granted")window.addEventListener("devicemotion",dmHandler);
    }).catch(()=>{});
  }else{
    window.addEventListener("devicemotion",dmHandler);
  }
}
function disableDM(){
  window.removeEventListener("devicemotion",dmHandler);
  lastBump=0;
}

/* main tick */
async function tick(){
  if(cleaned)return;
  const L=lum();
  if(!L)return;
  const now=performance.now();

  // auto black screen while armed & dark
  if(stt!==0 && blOff && blOff<CFG.BLK_LIM && L<CFG.BLK_LIM) blkOn();
  else if(stt===0 || L>CFG.BLK_LIM*1.5) blkOff();

  // shared dark+bump fallback: if very dark + crisp bump near now → toggle
  if(stt!==0 && blOff && blOff<CFG.DARK_LIM && lastBump){
    if(now-lastBump<CFG.DARK_BWIN && now-lastToggle>CFG.COOLDOWN_MS){
      const turnOn = (stt===1);
      await torch(turnOn);
      stt = turnOn ? 2 : 1;
      if(turnOn){
        blOn=0;nPrev=nCnt=nAcc=0;
      }else{
        blOff=0;oPrev=oCnt=oAcc=0;
      }
      upCnt=dnCnt=0;
      lastToggle=now;
      lastBump=0;
      touchAct();
      return;
    }
  }

  if(stt===1){ // ARMED_OFF
    if(!blOff){calOff(L);return;}

    // optical OFF -> ON: strong spike
    if(L>blOff*CFG.UP_F) upCnt++;
    else if(L<blOff*2) upCnt=0;

    if(upCnt>=CFG.TRIG_FR && now-lastToggle>CFG.COOLDOWN_MS){
      await torch(true);
      stt=2;
      blOn=0;nPrev=nCnt=nAcc=0;
      upCnt=0;dnCnt=0;
      lastToggle=now;
      touchAct();
      return;
    }

  }else if(stt===2){ // ARMED_ON
    if(!blOn){calOn(L);return;}

    // optical ON -> OFF: strong dark drop
    if(L<blOn/CFG.DN_F) dnCnt++;
    else if(L>blOn/1.5) dnCnt=0;

    if(dnCnt>=CFG.TRIG_FR && now-lastToggle>CFG.COOLDOWN_MS){
      await torch(false);
      stt=1;
      blOff=0;oPrev=oCnt=oAcc=0;
      upCnt=0;dnCnt=0;
      lastToggle=now;
      touchAct();
      return;
    }
  }
}

/* loops */
function startPoll(){
  if(itv)return;
  itv=setInterval(tick,CFG.TICK_MS);
  tmo=setTimeout(stopAll,CFG.SESSION_MS);
  mark(1);
  touchAct();
}
function stopPoll(){
  if(itv)clearInterval(itv);
  itv=null;
  if(tmo)clearTimeout(tmo);
  tmo=null;
}

/* stop core */
async function stopAll(){
  stopPoll();
  disableDM();
  blkOff();
  await torch(false);
  if(ms)ms.getTracks().forEach(t=>t.stop());
  ms=null;tr=null;
  blOff=blOn=0;
  oPrev=oCnt=oAcc=0;
  nPrev=nCnt=nAcc=0;
  upCnt=0;dnCnt=0;
  lastToggle=0;
  stt=0;
  mark(0);
  unlock();
  if(inactT)clearTimeout(inactT);
  inactT=null;
}

/* clean exit */
async function cleanExit(){
  if(cleaned)return;
  cleaned=1;
  await stopAll();
  try{location.replace("https://www.google.com");}catch(e){}
}

/* arm */
async function arm(){
  if(stt!==0||cleaned)return;
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return;
  try{
    ms=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}}
    });
    tr=ms.getVideoTracks()[0];
    v.srcObject=ms;
    const onReady=async()=>{
      if(stt!==0||cleaned)return;
      stt=1;
      blOff=blOn=0;
      oPrev=oCnt=oAcc=0;
      nPrev=nCnt=nAcc=0;
      upCnt=dnCnt=0;
      lastToggle=performance.now();
      enableDM();
      startPoll();
      lock();
    };
    if(v.readyState>=2)onReady();else v.onloadedmetadata=onReady;
    try{await v.play();}catch(e){}
  }catch(e){
    await stopAll();
  }
}

/* triple-tap: IDLE <-> ARMED */
(function(){
  let n=0,to=null,lastT=0,lastType="";
  function tap(e){
    const now=performance.now();
    if(lastType && e.type!==lastType && now-lastT<80){
      lastType=e.type;lastT=now;return;
    }
    lastType=e.type;lastT=now;
    n++;
    if(to)clearTimeout(to);
    if(n>=CFG.TAP_COUNT){
      n=0;to=null;
      if(stt===0)arm();else stopAll();
      touchAct();
    }else{
      to=setTimeout(()=>{n=0;to=null},CFG.TAP_WIN);
    }
  }
  [s,h].forEach(el=>{
    if(!el)return;
    el.style.cursor="pointer";
    el.addEventListener("click",tap,false);
    el.addEventListener("touchend",tap,false);
  });
})();

window.addEventListener("pagehide",cleanExit);
window.addEventListener("beforeunload",cleanExit);
</script>
</body>
</html>
